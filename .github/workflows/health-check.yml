name: Health Check

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

jobs:
  health-check:
    name: Check Service Health
    runs-on: ubuntu-latest

    steps:
      - name: Check agents.blackroad.io
        id: health
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://agents.blackroad.io/health --connect-timeout 10 || echo "000")
          echo "status=$HTTP_CODE" >> $GITHUB_OUTPUT
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Service is healthy"
          else
            echo "Service returned HTTP $HTTP_CODE"
          fi

      - name: Alert on failure
        if: steps.health.outputs.status != '200'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Health check failed for agents.blackroad.io",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Health Check Alert*\n\nService: `agents.blackroad.io`\nStatus: `${{ steps.health.outputs.status }}`\nTime: `${{ github.event.head_commit.timestamp || 'scheduled' }}`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Create issue on persistent failure
        if: steps.health.outputs.status != '200'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Service Health Alert: agents.blackroad.io returned ${{ steps.health.outputs.status }}`;
            const body = `## Health Check Failed\n\n- **Service**: agents.blackroad.io\n- **Status Code**: ${{ steps.health.outputs.status }}\n- **Time**: ${new Date().toISOString()}\n\nPlease investigate the service status.`;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-alert'
            });

            const existingIssue = issues.data.find(i => i.title.includes('Health Alert'));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['health-alert', 'urgent']
              });
            }
        continue-on-error: true
