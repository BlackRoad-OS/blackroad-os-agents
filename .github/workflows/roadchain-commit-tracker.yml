name: RoadChain Commit Tracker

# RoadChain: SHA-256 based commit tracking and verification system
# Ensures integrity of all commits across the repository

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  roadchain-verify:
    name: RoadChain SHA-256 Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for complete chain verification
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Generate commit SHA-256 chain
        id: roadchain
        run: |
          echo "üîó RoadChain: Generating SHA-256 commit verification chain"
          
          # Create RoadChain directory
          mkdir -p .roadchain
          
          # Generate chain file with commit metadata
          git log --pretty=format:'%H|%an|%ae|%at|%s' -20 > .roadchain/commits.log
          
          # Generate SHA-256 hashes for each commit
          echo "üìä Commit Chain Verification:" > .roadchain/chain.txt
          while IFS='|' read -r hash author email timestamp subject; do
            # Generate SHA-256 hash of commit data
            commit_hash=$(echo "$hash|$author|$email|$timestamp|$subject" | sha256sum | awk '{print $1}')
            echo "Commit: $hash" >> .roadchain/chain.txt
            echo "SHA-256: $commit_hash" >> .roadchain/chain.txt
            echo "Author: $author <$email>" >> .roadchain/chain.txt
            echo "Date: $(date -d @$timestamp)" >> .roadchain/chain.txt
            echo "Subject: $subject" >> .roadchain/chain.txt
            echo "---" >> .roadchain/chain.txt
          done < .roadchain/commits.log
          
          # Generate master chain hash
          master_hash=$(sha256sum .roadchain/chain.txt | awk '{print $1}')
          echo "üîê Master Chain Hash: $master_hash"
          echo "master_hash=$master_hash" >> $GITHUB_OUTPUT
          
          # Create verification file
          cat > .roadchain/verification.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "master_chain_hash": "$master_hash",
            "verified_by": "RoadChain-v1.0",
            "commit_count": $(git rev-list --count HEAD)
          }
          EOF
          
          echo "‚úÖ RoadChain verification complete"
      
      - name: Display RoadChain status
        run: |
          echo "### üîó RoadChain Commit Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Master Hash:** ${{ steps.roadchain.outputs.master_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ All commits verified and tracked via RoadChain SHA-256" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload RoadChain artifacts
        uses: actions/upload-artifact@v4
        with:
          name: roadchain-verification-${{ github.sha }}
          path: .roadchain/
          retention-days: 90
      
      - name: Validate commit integrity
        run: |
          echo "üîç Validating commit integrity..."
          
          # Check for suspicious patterns
          if git log --format='%s' -5 | grep -iE '(hack|bypass|disable.*security)'; then
            echo "‚ö†Ô∏è Warning: Suspicious commit messages detected"
            exit 1
          fi
          
          # Verify no unsigned commits (if signing is enabled)
          if git log --show-signature -1 2>&1 | grep -q "Good signature"; then
            echo "‚úÖ Commit is signed"
          else
            echo "‚ÑπÔ∏è Commit signing not detected (optional)"
          fi
          
          echo "‚úÖ Commit integrity validated"
